<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.js - Documentation | Social Core (msip-core) | Modular</title>
    
    <meta name="description" content="Documentation for the modular social information platform core component of Modular." />
    
    
    
    <meta property="og:title" content="Documentation | Social Core (msip-core) | Modular"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="../social-core.png"/>
    
    <meta property="og:url" content="https://msip.core.modular.social/docs"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://msip.core.modular.social/" >Project Website</a></h2><h2><a href="https://github.com/modular/social-core/" >GitHub Repository</a></h2><h3>Classes</h3><ul><li><a href="ModularMessage.html">ModularMessage</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Modular Social Information Platform Core (msip-core)
 * @copyright Modular 2020
 * @license MIT
 *
 * @description
 * The Modular Social Information Platform Core (msip-core) package is a core component of Modular.
 * It handles the social networking and communications algorithms that power the Modular information platform.
 *
 * @author Modulo (https://github.com/modulo) &lt;modzero@protonmail.com>
 */

/* global BigInt */
const { Network, NetworkStatus } = require('@modular/dmnc-core')
const { ModularSource, ModularVerifier } = require('@modular/smcc-core')
const { ModularConfiguration } = require('@modular/config')
const standard = require('@modular/standard')
const level = require('level')

class ModularPlatform {
  constructor (config, options = {}) {
    if (arguments.length !== 1 &amp;&amp; arguments.length !== 2) throw new RangeError('ModularPlatform constructor expects one or two arguments')
    if (!(config instanceof ModularConfiguration)) throw new TypeError('Config must be a valid ModularConfiguration object')
    if (typeof options !== 'object') throw new TypeError('Options must be a valid options object')

    this.config = ModularConfiguration.new(config)
    this.network = new Network(config, options)
    this.network.platform = this
    this.debugLogger = this.network.debugLogger
    this.network.registerHandler('SOCIAL', this.socialHandler)
    this.db = {}
    this.db.users = level('users')
    this.db.posts = level('posts')
    this.bigM = BigInt(this.network.network.M)
  }

  onReady (callback) {
    this.network.onReady(callback)
  }

  initialize () {
    this.network.initialize()
  }

  useEndpoint (endpoint) {
    this.network.useEndpoint(endpoint)
    this.network.setCoverage('0%1')
  }

  static async standard () {
    const config = await standard.config()
    return new ModularPlatform(config)
  }

  verifiedQuery (id, type, data) {
    const big = BigInt('0x' + id)
    const mod = big % this.bigM

    return new Promise((resolve, reject) => {
      const requests = [{ layer: 'SOCIAL', type: type, payload: data }]
      const peer = this.network.network.bestNodeCovering(Number(mod))
      this.network.peerQuery(peer.endpoint, requests).then((response) => {
        resolve(response.results[0].result)
      }).catch((error) => {
        reject(error)
      })
    })
  }

  socialHandler (type, request, network) {
    if (arguments.length !== 3) throw new RangeError('ModularPlatform.socialHandler() expects exactly three arguments')
    if (typeof type !== 'string') throw new TypeError('First argument to ModularPlatform.socialHandler() must be an string')
    if (typeof request !== 'object') throw new TypeError('Second argument to ModularPlatform.socialHandler() must be an object')
    if (!(network instanceof Network)) throw new TypeError('Third argument to ModularPlatform.socialHandler() must be a Network')

    switch (type) {
      case 'AHOY': return network.platform.ahoyHandler.bind(network.platform)(request.payload)
      case 'POST': return network.platform.postHandler.bind(network.platform)(request.payload)
      case 'REGISTER': return network.platform.registerHandler.bind(network.platform)(request.payload)
      case 'USER': return network.platform.fetchUser.bind(network.platform)(request.payload)
      default: throw new TypeError('SOCIAL handler cannot serve this request type')
    }
  }

  ahoyHandler (payload) {
    return new Promise((resolve, reject) => {
      if (this.network.status === NetworkStatus.READY) resolve('AYE AYE')
      else reject(new Error('NO NO'))
    })
  }

  postHandler (payload) {
    return new Promise((resolve, reject) => {
      resolve({
        dbPath: this.dbPath
      })
    })
  }

  static validateTimestamp (timestamp) {
    if (!Number.isInteger(timestamp)) throw new TypeError('Timestamp must be an integer')
    if (!(timestamp &lt;= Date.now())) throw new RangeError('Timestamp must be in the past')
    if (!(timestamp >= (Date.now() - 5000))) throw new RangeError('Timestamp must be recent')
  }

  async registerHandler (payload) {
    if (typeof payload.key !== 'string') throw new TypeError('Incomplete request payload.')
    if (typeof payload.profileUpdate.user !== 'string') throw new TypeError('Incomplete request payload.')
    if (payload.profileUpdate.type !== 'PROFILE') throw new TypeError('Incomplete request payload.')
    if (typeof payload.profileUpdate.body !== 'string') throw new TypeError('Incomplete request payload.')
    if (typeof payload.profileUpdate.signature !== 'string') throw new TypeError('Incomplete request payload.')
    if (!Array.isArray(payload.profile)) throw new TypeError('Incomplete request payload.')

    if (await ModularUser.exists(payload.profileUpdate.user)) throw new Error('Already registered.')
    ModularPlatform.validateTimestamp(payload.profileUpdate.timestamp)

    const verifier = await ModularVerifier.loadUser(payload.key)

    if (verifier.id !== payload.profileUpdate.user) throw new Error('UID does not match key.')

    if (!(await verifier.verifyProfileUpdate(payload.profileUpdate.signature, payload.profileUpdate.timestamp, payload.profile))) { throw new Error('Could not verify profile.') }

    const user = new ModularUser(this)
    user.key = payload.key
    user.id = verifier.id
    user.profile = payload.profile
    await user.save()

    return 'Saved user.'

    // propagate
  }

  fetchUser (payload) {
    return new Promise((resolve, reject) => {
      if (typeof payload.id !== 'string') throw new TypeError('User id must be a string')
      this.platform.db.users.get(payload.id, (err, value) => {
        if (err) reject(new Error('User does not exist.'))
        resolve(JSON.parse(value))
      })
    })
  }

  async registerUser (newProfile, passphrase) {
    const user = new ModularUser(this)
    const packet = await ModularSource.userRegistration(newProfile, passphrase)
    user.type = 'ME'
    user.source = packet.source
    user.id = packet.source.id
    user.key = packet.privateKeyArmored
    user.profile = newProfile
    user.save()
    this.db.users.put('ME', user.id)
    packet.request.profile = newProfile
    this.verifiedQuery(user.id, 'REGISTER', packet.request)
    return user
  }
}

class ModularUser {
  constructor (platform) {
    this.platform = platform
  }

  static async exists (uid) {
    this.platform.db.users.get(uid, (err, value) => {
      if (err) {
        return false
      }
      return true
    })
  }

  toString () {
    return JSON.stringify({
      id: this.id,
      key: this.key,
      profile: this.profile
    })
  }

  save () {
    return new Promise((resolve, reject) => {
      this.platform.db.users.put(this.id, this.toString(), (err) => {
        if (err) reject(err)
        else resolve()
      })
    })
  }

  static login (uid, passphrase) {}
  static other (uid) {}

  follow (user) {}

  /** @todo implementation */
  updateProfile (fields) {}

  /** @todo implementation */
  verifySocial (platform, username) {}

  /** @todo implementation */
  unfollow (user) {}

  /** @todo implementation */
  delete () {}

  /** @todo implementation */
  block (user) {}

  /** @todo implementation */
  unblock (user) {}

  /** @todo implementation */
  static hidePost (pidToHide) {}
}

class ModularPost {
  constructor (author) {
    this.author = author
  }

  setType (type) {}
  setTitle (title) {}
  setLink (link) {}
  setBody (body) {}
  setParent (parent) {}
  addModerator (moderator) {}
  upload () {}
}

/** @todo implementation */
class ModularMessage {
  constructor (sender, recipient) {
    this.sender = sender
    this.recipient = recipient
  }

  setBody (body) { this.body = body }
  send () {}
}

/* Module Exports */
module.exports.ModularPlatform = ModularPlatform
module.exports.ModularUser = ModularUser
module.exports.ModularPost = ModularPost
module.exports.ModularMessage = ModularMessage
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Fri Jul 03 2020 15:20:00 GMT-0500 (Central Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <link type="text/css" rel="stylesheet" href="../docs.css">
    
    <script src="../docs.js"></script>
    
</body>
</html>
